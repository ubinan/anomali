<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>DAUN PADI: Deteksi Anomali Ubinan Padi</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#f8f9fa; }
.card { border-radius:12px; }
.alert { white-space: pre-line; }

/* LOGIN */
#loginOverlay{
  position:fixed;
  inset:0;
  background:#f8f9fa;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.logo-padi svg{width:90px;height:90px;}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div id="loginOverlay">
  <div class="card p-4 shadow text-center" style="width:380px">

    <!-- LOGO PADI -->
    <div class="logo-padi mx-auto mb-2">
      <svg viewBox="0 0 100 100">
        <path d="M50 90 C45 65 35 50 20 30" stroke="#2e7d32" stroke-width="5" fill="none"/>
        <path d="M50 90 C55 65 65 50 80 30" stroke="#2e7d32" stroke-width="5" fill="none"/>
        <circle cx="20" cy="30" r="6" fill="#f9a825"/>
        <circle cx="26" cy="38" r="6" fill="#fbc02d"/>
        <circle cx="32" cy="26" r="6" fill="#f9a825"/>
        <circle cx="80" cy="30" r="6" fill="#f9a825"/>
        <circle cx="74" cy="38" r="6" fill="#fbc02d"/>
        <circle cx="68" cy="26" r="6" fill="#f9a825"/>
      </svg>
    </div>

    <h5 class="fw-bold mb-1">DAUN PADI</h5>
    <div class="text-muted mb-3">Deteksi Anomali Ubinan Padi</div>

    <input id="loginUser" class="form-control mb-2" placeholder="User">
    <input id="loginPass" type="password" class="form-control mb-2" placeholder="Password">

    <div id="loginError" class="text-danger small d-none mb-2">
      User atau password salah
    </div>

    <button class="btn btn-success w-100" onclick="doLogin()">Login</button>
  </div>
</div>

<!-- ================= DASHBOARD ================= -->
<div class="container-fluid p-4" id="dashboard" style="display:none">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="fw-bold">üåæ DAUN PADI: Deteksi Anomali Ubinan Padi</h4>
  <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
</div>

<div class="card mb-3">
  <div class="card-body">
    <label class="fw-bold">Pilih Sheet</label>
    <select id="sheetSelect" class="form-select"></select>
  </div>
</div>

<div id="sheetWarning" class="alert alert-danger d-none mb-3"></div>

<div id="noDataAlert" class="alert alert-info d-none mb-3">
  ‚ÑπÔ∏è <b>Tidak ditemukan Anomali</b>
</div>

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabTabel">Tabel Data</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabGrafik">Grafik</a></li>
</ul>

<div class="tab-content">

<!-- TAB TABEL -->
<div class="tab-pane fade show active" id="tabTabel">

<div class="card mb-3">
  <div class="card-body row g-3">
    <div class="col-md-3">
      <label>Filter Subround</label>
      <select id="filterSubround" class="form-select"><option value="ALL">Semua</option></select>
    </div>
    <div class="col-md-3">
      <label>Filter Kabupaten</label>
      <select id="filterKab" class="form-select"><option value="ALL">Semua</option></select>
    </div>
  </div>
</div>

<div class="table-responsive">
<table class="table table-bordered table-striped" id="dataTable">
  <thead></thead>
  <tbody></tbody>
</table>
</div>

</div>

<!-- TAB GRAFIK -->
<div class="tab-pane fade" id="tabGrafik">
  <canvas id="chartKab"></canvas>
</div>

</div>
</div>

<script>
/* ================= LOGIN ================= */
const users=[];
for(let i=3301;i<=3329;i++) users.push(String(i));
for(let i=3371;i<=3376;i++) users.push(String(i));

function doLogin(){
  if(users.includes(loginUser.value)&&loginUser.value===loginPass.value){
    sessionStorage.setItem("login","1");
    loginOverlay.style.display="none";
    dashboard.style.display="block";
  }else loginError.classList.remove("d-none");
}
function logout(){sessionStorage.clear();location.reload();}
if(sessionStorage.getItem("login")==="1"){
  loginOverlay.style.display="none";
  dashboard.style.display="block";
}

/* ================= API ================= */
const API_URL="https://script.google.com/macros/s/AKfycbx2dFcDZz-6foawOTtMtjE2XdG1V2it1UdnTi4ZVPIGn-lOsyPHK8Rvy13aAcCQGViROQ/exec";

/* ================= SHEET KHUSUS ================= */
const fullSheet=[
  "Progress","Penjelasan Anomali","Rekap Anomali","Subsegmen Anomali"
];

let rawData=[],header=[],chart;

/* ================= LOAD SHEET ================= */
fetch(API_URL+"?action=sheets")
.then(r=>r.json())
.then(list=>{
  const filtered=list.filter(s=>s.toLowerCase()!=="raw data");
  sheetSelect.innerHTML=filtered.map(s=>`<option>${s}</option>`).join("");
  loadData();
});
sheetSelect.onchange=loadData;

/* ================= LOAD DATA ================= */
function loadData(){
  fetch(API_URL+"?action=data&sheet="+sheetSelect.value)
  .then(r=>r.json())
  .then(res=>{
    header=[...res.header];
    rawData=[...res.data];

    if(!fullSheet.includes(sheetSelect.value)){
      rawData=rawData.filter(r=>r[header.indexOf("flag_2")]==1);
      if(rawData.length===0){
        noDataAlert.classList.remove("d-none");
        dataTable.tHead.innerHTML="";
        dataTable.tBodies[0].innerHTML="";
        if(chart) chart.destroy();
        return;
      }else noDataAlert.classList.add("d-none");
    }else{
      noDataAlert.classList.add("d-none");
    }

    buildFilters();
    renderTable();
    buildChart();
  });
}

/* ================= FILTER ================= */
function buildFilters(){
  fill(filterSubround,0);
  fill(filterKab,2);
}
function fill(sel,idx){
  const u=[...new Set(rawData.map(r=>r[idx]).filter(Boolean))];
  sel.innerHTML='<option value="ALL">Semua</option>'+u.map(v=>`<option>${v}</option>`).join('');
}
filterSubround.onchange=renderTable;
filterKab.onchange=renderTable;

/* ================= TABLE ================= */
function renderTable(){
  let data=[...rawData];
  if(filterSubround.value!="ALL") data=data.filter(r=>r[0]==filterSubround.value);
  if(filterKab.value!="ALL") data=data.filter(r=>r[2]==filterKab.value);

  let head=[...header];
  let rows=data.map(r=>[...r]);

  if(!fullSheet.includes(sheetSelect.value)){
    const idx=header.indexOf("flag_2");
    head.splice(idx+1,0,"Sesuai Lapangan","Butuh Perbaikan");
    rows=rows.map(r=>{
      r.splice(idx+1,0,'<input type="checkbox">','<input type="checkbox">');
      return r;
    });
  }

  dataTable.tHead.innerHTML="<tr>"+head.map(h=>`<th>${h}</th>`).join("")+"</tr>";
  dataTable.tBodies[0].innerHTML=rows.map(r=>"<tr>"+r.map(c=>`<td>${c??""}</td>`).join("")+"</tr>").join("");
}

/* ================= CHART ================= */
function buildChart(){
  if(fullSheet.includes(sheetSelect.value)){
    if(chart) chart.destroy();
    return;
  }
  const c={};
  rawData.forEach(r=>c[r[2]]=(c[r[2]]||0)+1);
  const labels=Object.keys(c).sort((a,b)=>Number(a)-Number(b));
  if(chart) chart.destroy();
  chart=new Chart(chartKab,{
    type:"bar",
    data:{labels,datasets:[{label:"Jumlah Flag_2 = 1",data:labels.map(l=>c[l])}]}
  });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
