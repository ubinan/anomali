<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>DAUN PADI: Deteksi Anomali Ubinan Padi</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#f8f9fa; }
.card { border-radius:12px; }
.alert { white-space: pre-line; }

/* LOGIN */
#loginOverlay{
  position:fixed;
  inset:0;
  background:#f8f9fa;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.logo-padi svg{width:90px;height:90px;}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div id="loginOverlay">
  <div class="card p-4 shadow text-center" style="width:380px">

    <div class="logo-padi mx-auto mb-2">
      <svg viewBox="0 0 100 100">
        <path d="M50 90 C45 65 35 50 20 30" stroke="#2e7d32" stroke-width="5" fill="none"/>
        <path d="M50 90 C55 65 65 50 80 30" stroke="#2e7d32" stroke-width="5" fill="none"/>
        <circle cx="20" cy="30" r="6" fill="#f9a825"/>
        <circle cx="26" cy="38" r="6" fill="#fbc02d"/>
        <circle cx="32" cy="26" r="6" fill="#f9a825"/>
        <circle cx="80" cy="30" r="6" fill="#f9a825"/>
        <circle cx="74" cy="38" r="6" fill="#fbc02d"/>
        <circle cx="68" cy="26" r="6" fill="#f9a825"/>
      </svg>
    </div>

    <h5 class="fw-bold mb-1">DAUN PADI</h5>
    <div class="text-muted mb-3">Deteksi Anomali Ubinan Padi</div>

    <input id="loginUser" class="form-control mb-2" placeholder="User">
    <input id="loginPass" type="password" class="form-control mb-2" placeholder="Password">

    <div id="loginError" class="text-danger small d-none mb-2">
      User atau password salah
    </div>

    <button class="btn btn-success w-100" onclick="doLogin()">Login</button>
  </div>
</div>

<!-- ================= DASHBOARD ================= -->
<div class="container-fluid p-4" id="dashboard" style="display:none">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="fw-bold">üåæ DAUN PADI: Deteksi Anomali Ubinan Padi</h4>
  <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
</div>

<div class="card mb-3">
  <div class="card-body">
    <label class="fw-bold">Pilih Sheet</label>
    <select id="sheetSelect" class="form-select"></select>
  </div>
</div>

<!-- WARNING SHEET -->
<div id="sheetWarning" class="alert alert-danger d-none mb-3"></div>

<div id="noDataAlert" class="alert alert-info d-none mb-3">
  ‚ÑπÔ∏è <b>Tidak ditemukan Anomali</b>
</div>

<!-- FILTERS (GLOBAL) -->
<div class="card mb-3">
  <div class="card-body row g-3">
    <div class="col-md-3">
      <label>Filter Subround</label>
      <select id="filterSubround" class="form-select"><option value="ALL">Semua</option></select>
    </div>
    <div class="col-md-3">
      <label>Filter Kabupaten</label>
      <select id="filterKab" class="form-select"><option value="ALL">Semua</option></select>
    </div>
  </div>
</div>

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabTabel">Tabel Data</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabGrafik">Grafik</a></li>
</ul>

<div class="tab-content">

<!-- TAB TABEL -->
<div class="tab-pane fade show active" id="tabTabel">

<div class="table-responsive">
<table class="table table-bordered table-striped" id="dataTable">
  <thead></thead>
  <tbody></tbody>
</table>
</div>

</div>

<!-- TAB GRAFIK -->
<div class="tab-pane fade" id="tabGrafik">
  <canvas id="chartKab"></canvas>
</div>

</div>
</div>

<script>
/* ================= LOGIN ================= */
const users=[];
for(let i=3301;i<=3329;i++) users.push(String(i));
for(let i=3371;i<=3376;i++) users.push(String(i));

function doLogin(){
  if(users.includes(loginUser.value)&&loginUser.value===loginPass.value){
    sessionStorage.setItem("login","1");
    loginOverlay.style.display="none";
    dashboard.style.display="block";
  }else loginError.classList.remove("d-none");
}
function logout(){sessionStorage.clear();location.reload();}
if(sessionStorage.getItem("login")==="1"){
  loginOverlay.style.display="none";
  dashboard.style.display="block";
}

/* ================= API ================= */
const API_URL="https://script.google.com/macros/s/AKfycbx2dFcDZz-6foawOTtMtjE2XdG1V2it1UdnTi4ZVPIGn-lOsyPHK8Rvy13aAcCQGViROQ/exec";

/* ================= WARNING TEXT ================= */
const warningText = {
  strata: "Pastikan pengisian strata sudah sesuai kondisi petak, terutama memastikan tidak terjadi kekeliruan antara Padi Ladang dan Padi Sawah Non-Irigasi.",
  strata_r601: "Periksa dan koreksi isian strata padi apabila tidak selaras dengan jenis lahan, seperti strata Padi Sawah yang tercatat pada lahan Bukan Sawah, atau strata Padi Ladang yang tercatat pada lahan Sawah Irigasi.",
  r501: "Saat ini, kegiatan Survei Ubinan hanya dilaksanakan oleh BPS",
  r604: "Lakukan verifikasi luas pada r604 adalah luas seluruh petak yang dikuasai petani dengan jenis tanaman padi dalam bidang yang sama dengan petak yang diubin",
  r605: "Pastikan pola penanaman Campuran/Tumpangsari dilakukan pada petak yang sama (bukan di pematang/galengan), serta cantumkan jenis tanaman tumpangsari pada Blok Catatan.",
  r607_r801b_r802b: "Jika R801B atau R802B terisi, maka R607 harus terisi 1 (Bantuan Pemerintah).",
  benih_per_hektar: "Pastikan penggunaan benih hanya pada bidang yang sama dengan r604.",
  pupuk_per_hektar: "Jumlah pupuk adalah total pupuk dalam kg (1 kg/liter untuk pupuk cair). Pastikan hanya pada bidang r604.",
  r701: "Konfirmasi berat ubinan ekstrem dan tambahkan catatan.",
  r702: "Konfirmasi jumlah rumpun ekstrem dan tambahkan catatan.",
  r809: "Pastikan persepsi petani sejalan dengan produktivitas."
};

/* ================= SHEET KHUSUS ================= */
const fullSheet=["Progress","Penjelasan Anomali","Rekap Anomali","Subsegmen Anomali"];

/* ================= RED COLUMNS ================= */
const redColumns = ["strata", "strata_r601", "r501", "r604", "r605", "r607_r801b_r802b", "benih_per_hektar", "pupuk_per_hektar", "r701", "r702", "r809"];

let rawData=[],header=[],chart;

/* ================= LOAD SHEET ================= */
fetch(API_URL+"?action=sheets")
.then(r=>r.json())
.then(list=>{
  sheetSelect.innerHTML=list.filter(s=>s.toLowerCase()!=="raw data")
    .map(s=>`<option>${s}</option>`).join("");
  loadData();
});
sheetSelect.onchange=loadData;

/* ================= WARNING HANDLER ================= */
function updateWarning(){
  const key=sheetSelect.value;
  if(warningText[key]){
    sheetWarning.textContent=warningText[key];
    sheetWarning.classList.remove("d-none");
  }else{
    sheetWarning.classList.add("d-none");
  }
}

/* ================= LOAD DATA ================= */
function loadData(){
  updateWarning();

  fetch(API_URL+"?action=data&sheet="+sheetSelect.value)
  .then(r=>r.json())
  .then(res=>{
    header=[...res.header];
    rawData=[...res.data];

    if(sheetSelect.value === "Subsegmen Anomali"){
      const totalIdx = header.indexOf("TOTAL");
      if(totalIdx !== -1){
        rawData = rawData.filter(r => Number(r[totalIdx]) > 0);
      }
    } else if(!fullSheet.includes(sheetSelect.value)){
      rawData=rawData.filter(r=>r[header.indexOf("flag_2")]==1);
    }

    if(rawData.length===0){
      noDataAlert.classList.remove("d-none");
      dataTable.tHead.innerHTML="";
      dataTable.tBodies[0].innerHTML="";
      if(chart) chart.destroy();
      return;
    }else noDataAlert.classList.add("d-none");

    buildFilters();
    renderTable();
    buildChart();
  });
}

/* ================= FILTER ================= */
function buildFilters(){
  fill(filterSubround,0);
  fill(filterKab,2);
}
function fill(sel,idx){
  const u=[...new Set(rawData.map(r=>r[idx]).filter(Boolean))];
  sel.innerHTML='<option value="ALL">Semua</option>'+u.map(v=>`<option>${v}</option>`).join('');
}
filterSubround.onchange=()=>{renderTable(); buildChart();};
filterKab.onchange=()=>{renderTable(); buildChart();};

/* ================= GET FILTERED DATA ================= */
function getFilteredData(){
  let data=[...rawData];
  if(filterSubround.value!="ALL") data=data.filter(r=>r[0]==filterSubround.value);
  if(filterKab.value!="ALL") data=data.filter(r=>r[2]==filterKab.value);
  return data;
}

/* ================= LOCAL STORAGE FOR CHECKBOX ================= */
function getCheckboxKey(sheet, subround, kab, index){
  return `checkbox-${sheet}-${subround}-${kab}-${index}`;
}
function saveCheckbox(sheet, subround, kab, index, type, checked){
  const key = getCheckboxKey(sheet, subround, kab, index) + `-${type}`;
  localStorage.setItem(key, checked ? "1" : "0");
}
function loadCheckbox(sheet, subround, kab, index, type){
  const key = getCheckboxKey(sheet, subround, kab, index) + `-${type}`;
  return localStorage.getItem(key) === "1";
}

/* ================= TABLE ================= */
function renderTable(){
  let data=getFilteredData();
  let head=[...header];
  let rows=data.map(r=>[...r]);

  if(!fullSheet.includes(sheetSelect.value)){
    const idx=header.indexOf("flag_2");
    head.splice(idx+1,0,"Sesuai Lapangan","Butuh Perbaikan");
    rows=rows.map((r, i)=>{
      const subround = r[0];
      const kab = r[2];
      const checked1 = loadCheckbox(sheetSelect.value, subround, kab, i, "sesuai") ? "checked" : "";
      const checked2 = loadCheckbox(sheetSelect.value, subround, kab, i, "perbaikan") ? "checked" : "";
      r.splice(idx+1,0,
        `<input type="checkbox" ${checked1} onchange="handleCheckbox(this, '${sheetSelect.value}', '${subround}', '${kab}', ${i}, 'sesuai')">`,
        `<input type="checkbox" ${checked2} onchange="handleCheckbox(this, '${sheetSelect.value}', '${subround}', '${kab}', ${i}, 'perbaikan')">`
      );
      return r;
    });
  }

  dataTable.tHead.innerHTML="<tr>"+head.map(h=>`<th>${h}</th>`).join("")+"</tr>";
  dataTable.tBodies[0].innerHTML=rows.map(r=>"<tr>"+r.map((c, j)=>{
    let className = "";
    if (redColumns.includes(head[j]) && Number(c) === 1) {
      className = "bg-danger text-white";
    }
    return `<td class="${className}">${c??""}</td>`;
  }).join("")+"</tr>").join("");
}

/* ================= HANDLE CHECKBOX ================= */
function handleCheckbox(cb, sheet, subround, kab, index, type){
  saveCheckbox(sheet, subround, kab, index, type, cb.checked);
}

/* ================= CHART ================= */
function buildChart(){
  if(chart) chart.destroy();
  if(sheetSelect.value === "Progress"){
    const data = getFilteredData();
    const kabIdx = 1; // Kolom B
    const targetIdx = 3; // Kolom D
    const realisasiIdx = 4; // Kolom E
    if(data.length === 0){
      console.log("Data kosong untuk Progress.");
      return;
    }
    const grouped = {};
    data.forEach(r => {
      const kab = r[kabIdx];
      if(kab !== "00"){ // Skip kabupaten 00
        if(!grouped[kab]) grouped[kab] = {target: 0, realisasi: 0};
        grouped[kab].target += Number(r[targetIdx]) || 0;
        grouped[kab].realisasi += Number(r[realisasiIdx]) || 0;
      }
    });
    const labels = Object.keys(grouped).sort((a,b)=>Number(a)-Number(b));
    chart = new Chart(chartKab, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "Target",
            data: labels.map(l => grouped[l].target),
            backgroundColor: "#90EE90" // Hijau muda
          },
          {
            label: "Realisasi",
            data: labels.map(l => grouped[l].realisasi),
            backgroundColor: "#228B22" // Hijau tua
          }
        ]
      },
      options: {
        scales: {
          x: { stacked: false },
          y: { stacked: false }
        }
      }
    });
  } else if(sheetSelect.value === "Subsegmen Anomali"){
    const data = getFilteredData();
    const kabIdx = 2; // Asumsi kolom Kabupaten adalah indeks 2 (sesuai filterKab)
    const totalIdx = header.indexOf("TOTAL");
    if(totalIdx === -1 || data.length === 0){
      console.log("Kolom TOTAL tidak ditemukan atau data kosong untuk Subsegmen Anomali.");
      return;
    }
    const grouped = {};
    data.forEach(r => {
      const kab = r[kabIdx];
      if(!grouped[kab]) grouped[kab] = 0;
      grouped[kab] += Number(r[totalIdx]) || 0;
    });
    const labels = Object.keys(grouped).sort((a,b)=>Number(a)-Number(b));
    chart = new Chart(chartKab, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "TOTAL",
          data: labels.map(l => grouped[l]),
          backgroundColor: "#FFD700" // Warna kuning untuk TOTAL
        }]
      },
      options: {
        scales: {
          x: { stacked: false },
          y: { stacked: false }
        }
      }
    });
  } else if(!fullSheet.includes(sheetSelect.value)){
    const data = getFilteredData();
    const c = {};
    data.forEach(r => c[r[2]] = (c[r[2]] || 0) + 1);
    const labels = Object.keys(c).sort((a,b)=>Number(a)-Number(b));
    chart = new Chart(chartKab, {
      type: "bar",
      data: { labels, datasets: [{ label: "Jumlah Flag_2 = 1", data: labels.map(l => c[l]) }] }
    });
  }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
